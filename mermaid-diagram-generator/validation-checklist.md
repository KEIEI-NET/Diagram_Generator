# Mermaid図バリデーションチェックリスト

*バージョン: 1.2.0*
*作成日: 2025年11月18日*

このドキュメントは、Claudeが Mermaid図を生成する際に参照する詳細なバリデーション手順とエラーパターンのデータベースです。

---

## 📋 マスターチェックリスト

Mermaid図を生成後、以下のチェックリストを**必ず**実行してください。

### Phase 1: 基本構文の検証

#### 1.1 コードブロック

- [ ] コードは ````mermaid` で開始している
- [ ] コードは ```` で終了している
- [ ] コードブロック外に余分な文字がない

#### 1.2 ダイアグラム宣言

- [ ] 第1行目に有効な宣言がある
- [ ] 宣言の綴りが正しい（大文字小文字を含む）
- [ ] 余分な空白や文字がない

**有効な宣言一覧**:
```
classDiagram
sequenceDiagram
stateDiagram-v2
erDiagram
flowchart TB
flowchart TD
flowchart LR
flowchart RL
graph TB (非推奨)
graph TD (非推奨)
graph LR (非推奨)
graph RL (非推奨)
```

#### 1.3 コメント

- [ ] すべてのコメントが `%%` で開始している
- [ ] `//` や `<!-- -->` が使用されていない
- [ ] コメントが適切に配置されている（行の途中ではなく独立行または行末）

#### 1.4 引用符の整合性

- [ ] すべての `"` が対になっている
- [ ] すべての `[` と `]` が対になっている
- [ ] エスケープが必要な引用符が適切にエスケープされている

#### 1.5 矢印記法

- [ ] すべての矢印が有効な記法である
- [ ] 単一の `>`, `-`, `.` が使用されていない
- [ ] 矢印の前後に適切な要素がある

### Phase 2: 図タイプ別の検証

#### 2.1 クラス図 (classDiagram)

**要素数**:
- [ ] クラス数 ≤ 12個
- [ ] 属性数（1クラスあたり）≤ 5個
- [ ] メソッド数（1クラスあたり）≤ 5個
- [ ] リレーション総数 ≤ 15本

**構文**:
- [ ] クラス名が英数字とアンダースコアのみ
- [ ] 属性・メソッドの可視性記号が正しい（`+`, `-`, `#`, `~`）
- [ ] リレーションの矢印が有効
- [ ] ジェネリクス `<>` を使用していない

**リレーション矢印**:
- `<|--`: 継承
- `*--`: コンポジション
- `o--`: 集約
- `-->`: 関連
- `..>`: 依存
- `..|>`: 実装

#### 2.2 シーケンス図 (sequenceDiagram)

**要素数**:
- [ ] 参加者 ≤ 7人
- [ ] メッセージ ≤ 15本
- [ ] alt/loop/optのネスト ≤ 2階層

**構文**:
- [ ] すべてのメッセージ送信者・受信者が定義済み
- [ ] メッセージ矢印が有効（`->>`, `-->>`, `->>+`, `->>-`, `->`, `-->` など）
- [ ] alt, loop, opt, par が正しく `end` で閉じられている
- [ ] activate/deactivate が対になっている

**メッセージ矢印**:
- `->>`: 実線矢印
- `-->>`: 点線矢印
- `->>+`: アクティベーション付き
- `->>-`: デアクティベーション付き
- `->`: 非同期
- `-->`: 非同期点線

#### 2.3 ステートマシン図 (stateDiagram-v2)

**要素数**:
- [ ] 状態 ≤ 10個
- [ ] 遷移 ≤ 15本
- [ ] 複合状態のネスト ≤ 1階層

**構文**:
- [ ] 宣言が `stateDiagram-v2`（v2必須）
- [ ] 開始状態 `[*]` がある
- [ ] 終了状態 `[*]` がある（オプション）
- [ ] 状態名が有効（英数字、アンダースコア、スペース可）
- [ ] 遷移が `-->` を使用

#### 2.4 ER図 (erDiagram)

**要素数**:
- [ ] エンティティ ≤ 10個
- [ ] 属性（1エンティティあたり）≤ 8個
- [ ] リレーション ≤ 12本

**構文**:
- [ ] エンティティ名が大文字（推奨）
- [ ] リレーションのカーディナリティが有効
- [ ] 属性の型が記載されている（推奨）

**カーディナリティ**:
- `||--||`: 1対1
- `||--o{`: 1対多
- `}o--o{`: 多対多

#### 2.5 フローチャート (flowchart)

**要素数**:
- [ ] ノード ≤ 15個
- [ ] エッジ ≤ 20本
- [ ] サブグラフのネスト ≤ 2階層

**構文**:
- [ ] 方向指定が有効（TB, TD, LR, RL）
- [ ] ノードの形状記号が正しい
- [ ] エッジの矢印が有効
- [ ] サブグラフが正しく `end` で閉じられている

**ノード形状**:
- `[テキスト]`: 長方形
- `(テキスト)`: 角丸長方形
- `([テキスト])`: スタジアム型
- `[[テキスト]]`: サブルーチン型
- `{テキスト}`: ひし形
- `{{テキスト}}`: 六角形
- `[(テキスト)]`: データベース型
- `((テキスト))`: 円形

### Phase 3: 複雑度の検証

#### 3.1 自動複雑度計算

図タイプに応じて、以下の計算式で複雑度を算出：

**クラス図**:
```
complexity = (classes × 1.0) + (attributes × 0.3) + (methods × 0.3) + (relations × 0.5)
```
- [ ] complexity < 25 (Simple)
- [ ] complexity < 40 (Moderate - 警告)
- [ ] complexity ≥ 40 (Complex - 分割推奨)

**シーケンス図**:
```
complexity = (participants × 2.0) + (messages × 1.0) + (nesting × 5.0) + (branches × 3.0)
```
- [ ] complexity < 25 (Simple)
- [ ] complexity < 40 (Moderate)
- [ ] complexity ≥ 40 (Complex)

**ステートマシン図**:
```
complexity = (states × 1.5) + (transitions × 1.0) + (composite × 5.0)
```
- [ ] complexity < 25 (Simple)
- [ ] complexity < 40 (Moderate)
- [ ] complexity ≥ 40 (Complex)

**ER図**:
```
complexity = (entities × 1.5) + (attributes × 0.3) + (relationships × 1.0)
```
- [ ] complexity < 25 (Simple)
- [ ] complexity < 40 (Moderate)
- [ ] complexity ≥ 40 (Complex)

**フローチャート**:
```
complexity = (nodes × 1.0) + (edges × 0.8) + (subgraphs × 3.0) + (branches × 2.0)
```
- [ ] complexity < 25 (Simple)
- [ ] complexity < 40 (Moderate)
- [ ] complexity ≥ 40 (Complex)

### Phase 4: プラットフォーム互換性

#### 4.1 GitHub

- [ ] 総ノード数 < 20個
- [ ] レンダリング時間 < 3秒（予測）
- [ ] 複雑すぎる図ではない
- [ ] ファイルサイズ < 10KB（推奨）

#### 4.2 VS Code / Cursor

- [ ] UTF-8エンコーディング
- [ ] 日本語ラベルが正しく表示される
- [ ] 特殊文字が最小限

#### 4.3 一般的なプラットフォーム

- [ ] HTMLタグを使用していない
- [ ] `<br>` を使用していない（改行文字を使用）
- [ ] 外部リンクを含まない
- [ ] JavaScriptコードを含まない

### Phase 5: 可読性とスタイル

#### 5.1 ラベルの長さ

- [ ] すべてのラベル ≤ 30文字
- [ ] 長いラベルは適切に短縮されている
- [ ] 略語が一貫している

#### 5.2 命名規則

- [ ] クラス名・エンティティ名: 英語（PascalCase推奨）
- [ ] メソッド名・属性名: 英語（camelCase推奨）
- [ ] ラベル・説明: 日本語OK
- [ ] 一貫した命名規則

#### 5.3 インデントとフォーマット

- [ ] 適切なインデント（2または4スペース）
- [ ] 空行で論理的にグループ化
- [ ] コメントで説明が追加されている
- [ ] 1行の長さ < 100文字

---

## 🚫 よくあるエラーパターンと修正方法

### エラー1: 無効な矢印記法

**検出**: `(?<!-)->(?!>)` (単一の `>`)

**例**:
```mermaid
A -> B   ❌
```

**修正**:
```mermaid
A --> B   ✅
```

### エラー2: 閉じていない引用符

**検出**: `"[^"]*$` (行末で閉じていない `"`)

**例**:
```mermaid
A["ラベル] --> B   ❌
```

**修正**:
```mermaid
A["ラベル"] --> B   ✅
```

### エラー3: 無効なコメント

**検出**: `^\s*//` (JavaScriptスタイル)

**例**:
```mermaid
// これはコメント   ❌
```

**修正**:
```mermaid
%% これはコメント   ✅
```

### エラー4: 特殊文字の未エスケープ

**検出**: `[<>{}\#]` (ラベル内)

**例**:
```mermaid
A->>B: <getData>を呼び出し   ❌
```

**修正**:
```mermaid
A->>B: getDataを呼び出し   ✅
```

### エラー5: ネストの深すぎる構造

**検出**: alt/loop/optが3階層以上

**例**:
```mermaid
alt 条件1
    alt 条件2
        alt 条件3   ❌ 3階層目
        end
    end
end
```

**修正**:
```mermaid
alt 条件1
    alt 条件2   ✅ 2階層まで
    end
end
```

### エラー6: 要素数の超過

**検出**: 要素数が制限を超えている

**修正**: 図を分割

```mermaid
%% 元の図（クラスが20個）
❌ 複雑すぎる
```

**修正後**:
```mermaid
%% 図1: プレゼンテーション層（5クラス）
✅

%% 図2: ビジネス層（8クラス）
✅

%% 図3: データ層（7クラス）
✅
```

---

## 🔧 自動修正のガイドライン

Claudeが自動的にエラーを修正する場合の優先順位：

### 優先度 High（即座に修正）

1. **無効な矢印の修正**
   - `>` → `-->`
   - `-` → `-->`

2. **コメントの修正**
   - `//` → `%%`
   - `<!-- -->` → `%%`

3. **引用符の閉じ忘れ修正**
   - 開いている引用符を検出して閉じる

4. **無効な宣言の修正**
   - `class-diagram` → `classDiagram`
   - `sequencechart` → `sequenceDiagram`

### 優先度 Medium（警告して修正）

5. **長いラベルの短縮**
   - 30文字を超える場合、省略して `...` を追加

6. **特殊文字の除去**
   - `< >` を除去または置換

7. **ネストの簡素化**
   - 3階層以上のネストを2階層に簡素化

### 優先度 Low（ユーザーに確認）

8. **要素数の削減**
   - 図を分割する提案

9. **複雑度の削減**
   - 不要な要素を削除する提案

10. **可読性の向上**
    - より明確な命名の提案

---

## 📊 バリデーション完了の確認

すべてのフェーズが完了し、以下の条件を満たす場合、バリデーション成功：

- [x] Phase 1: 基本構文 - すべてパス
- [x] Phase 2: 図タイプ別検証 - すべてパス
- [x] Phase 3: 複雑度 - Simple または Moderate
- [x] Phase 4: プラットフォーム互換性 - すべてパス
- [x] Phase 5: 可読性とスタイル - すべてパス

**最終確認**: Mermaid Live Editor (https://mermaid.live/) で正常に表示される

---

## 🎯 推奨ワークフロー

1. **要件分析** → 図の種類と要素を特定
2. **簡素化判断** → 複雑度を予測し、必要なら分割
3. **図の生成** → Mermaidコードを生成
4. **Phase 1-5 バリデーション** → このチェックリストを実行
5. **エラー修正** → 検出されたエラーを修正
6. **再バリデーション** → すべてパスするまで繰り返し
7. **最終確認** → Mermaid Live Editorで確認
8. **完了** → ユーザーに提供

---

*最終更新: 2025年11月18日*
*著作権: (c) 2025 KEIEI.NET INC.*
*作成者: KENJI OYAMA*
*バージョン: 1.2.0*
